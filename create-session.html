<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create/Join Zoom Video Session</title>
    <!-- Zoom Video SDK - Using unpkg CDN for dependencies -->
    <script crossorigin src="https://unpkg.com/react@17/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@17/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/redux@4/dist/redux.min.js"></script>
    <script src="https://unpkg.com/redux-thunk@2/dist/redux-thunk.min.js"></script>
    <script src="https://unpkg.com/lodash@4/lodash.min.js"></script>
    <!-- Zoom Video SDK - Load from local server first, then fallback to CDN -->
    <script src="/zoom-sdk/index.umd.js" 
            onerror="console.warn('Local SDK failed, trying CDN...'); 
                     var s=document.createElement('script'); 
                     s.src='https://unpkg.com/@zoom/videosdk@latest/dist/index.umd.js'; 
                     s.onerror=()=>console.error('All SDK sources failed'); 
                     s.onload=()=>console.log('SDK loaded from unpkg'); 
                     document.head.appendChild(s);"
            onload="console.log('Zoom Video SDK loaded from local server')"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        h1 {
            color: #2d3748;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #718096;
        }

        .form-container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            color: #2d3748;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-danger {
            background: linear-gradient(135deg, #f56565 0%, #c53030 100%);
        }

        .video-container {
            background: #1a202c;
            border-radius: 20px;
            padding: 20px;
            margin-top: 20px;
            min-height: 500px;
            display: none;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .video-container.active {
            display: block;
        }

        #video-canvas {
            width: 100%;
            height: 100%;
            min-height: 400px;
            border-radius: 10px;
            background: #2d3748;
            object-fit: cover;
            display: block;
        }

        .video-wrapper {
            position: relative;
            width: 100%;
            height: 100%;
            min-height: 400px;
            border-radius: 10px;
            overflow: hidden;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .controls button {
            flex: 1;
        }

        .status {
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            font-size: 0.9rem;
        }

        .status.success {
            background: #c6f6d5;
            color: #22543d;
            border: 1px solid #9ae6b4;
        }

        .status.error {
            background: #fed7d7;
            color: #742a2a;
            border: 1px solid #fc8181;
        }

        .status.info {
            background: #bee3f8;
            color: #2c5282;
            border: 1px solid #90cdf4;
        }

        .back-link {
            display: inline-block;
            color: #667eea;
            text-decoration: none;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .back-link:hover {
            text-decoration: underline;
        }

        .help-text {
            font-size: 0.85rem;
            color: #718096;
            margin-top: 5px;
        }

        .error-text {
            font-size: 0.85rem;
            color: #f56565;
            margin-top: 5px;
            font-weight: 500;
        }

        .success-text {
            font-size: 0.85rem;
            color: #48bb78;
            margin-top: 5px;
            font-weight: 500;
        }

        .tab-btn {
            background: transparent;
            border: none;
            padding: 12px 20px;
            font-size: 1rem;
            font-weight: 600;
            color: #718096;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }

        .tab-btn:hover {
            color: #667eea;
        }

        .tab-btn.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="index.html" class="back-link">‚Üê Back to Home</a>

        <div class="header">
            <h1>üé• Create/Join Video Session</h1>
            <p class="subtitle">Enter your session details to start or join a Zoom Video SDK session</p>
            <div style="margin-top: 15px; padding: 15px; background: #f0f4ff; border-radius: 8px; font-size: 0.9rem;">
                <strong>üí° Quick Guide:</strong>
                <ul style="margin: 10px 0 0 20px; color: #4a5568;">
                    <li><strong>Session Name:</strong> Any name (e.g., "MySession") - same name = same session</li>
                    <li><strong>Your Name:</strong> Your display name (e.g., "John Doe")</li>
                    <li><strong>Session Key:</strong> Any string (e.g., "key-123") - use same key to join same session</li>
                    <li><strong>Role:</strong> Host (create) or Participant (join)</li>
                </ul>
            </div>
        </div>

        <!-- Tabs for Create vs Join -->
        <div class="form-container" id="formContainer">
            <div style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #e2e8f0;">
                <button type="button" class="tab-btn active" id="createTab" onclick="switchTab('create')">
                    ‚ûï Create Session
                </button>
                <button type="button" class="tab-btn" id="joinTab" onclick="switchTab('join')">
                    üîó Join Session
                </button>
            </div>

            <!-- Create Session Form -->
            <form id="createSessionForm" style="display: block;">
                <h2 style="color: #2d3748; margin-bottom: 20px; font-size: 1.3rem;">Create a New Video Session</h2>
                
                <div class="form-group">
                    <label for="createSessionName">Session Name *</label>
                    <input 
                        type="text" 
                        id="createSessionName" 
                        name="createSessionName" 
                        placeholder="e.g., TeamMeeting-2024" 
                        required
                        pattern="[a-zA-Z0-9_\-]+"
                        maxlength="200"
                    >
                    <p class="help-text" id="createSessionNameHelp">Choose a unique name for your session (letters, numbers, hyphens, underscores only)</p>
                </div>

                <div class="form-group">
                    <label for="createUserIdentity">Your Name (Host) *</label>
                    <input 
                        type="text" 
                        id="createUserIdentity" 
                        name="createUserIdentity" 
                        placeholder="e.g., John Doe" 
                        required
                        maxlength="100"
                    >
                    <p class="help-text" id="createUserIdentityHelp">Your display name as the session host</p>
                </div>

                <div class="form-group">
                    <label for="createSessionKey">Session Key *</label>
                    <input 
                        type="text" 
                        id="createSessionKey" 
                        name="createSessionKey" 
                        placeholder="e.g., secure-key-123" 
                        required
                        maxlength="200"
                    >
                    <p class="help-text" id="createSessionKeyHelp">Create a secure key for this session. Share this with participants to join.</p>
                </div>

                <div class="form-group" style="background: #f0f4ff; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <p style="color: #4a5568; font-size: 0.9rem; margin: 0;">
                        <strong>üí° Note:</strong> As the host, you'll be able to manage the session. 
                        Share the Session Name and Session Key with others so they can join.
                    </p>
                </div>

                <button type="submit" class="btn" id="createBtn" style="background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);">
                    ‚ûï Create & Join Session
                </button>
            </form>

            <!-- Join Session Form -->
            <form id="joinSessionForm" style="display: none;">
                <h2 style="color: #2d3748; margin-bottom: 20px; font-size: 1.3rem;">Join an Existing Session</h2>
                
                <div class="form-group">
                    <label for="joinSessionName">Session Name *</label>
                    <input 
                        type="text" 
                        id="joinSessionName" 
                        name="joinSessionName" 
                        placeholder="e.g., TeamMeeting-2024" 
                        required
                        pattern="[a-zA-Z0-9_\-]+"
                        maxlength="200"
                    >
                    <p class="help-text" id="joinSessionNameHelp">Enter the exact session name provided by the host</p>
                </div>

                <div class="form-group">
                    <label for="joinUserIdentity">Your Name *</label>
                    <input 
                        type="text" 
                        id="joinUserIdentity" 
                        name="joinUserIdentity" 
                        placeholder="e.g., Jane Smith" 
                        required
                        maxlength="100"
                    >
                    <p class="help-text" id="joinUserIdentityHelp">Your display name in the session</p>
                </div>

                <div class="form-group">
                    <label for="joinSessionKey">Session Key *</label>
                    <input 
                        type="text" 
                        id="joinSessionKey" 
                        name="joinSessionKey" 
                        placeholder="e.g., secure-key-123" 
                        required
                        maxlength="200"
                    >
                    <p class="help-text" id="joinSessionKeyHelp">Enter the session key provided by the host</p>
                </div>

                <button type="submit" class="btn" id="joinBtn">
                    üîó Join Session
                </button>
            </form>

            <div id="status" class="status" style="display: none;"></div>
        </div>

        <div class="video-container" id="videoContainer">
            <div class="video-wrapper">
                <video id="video-canvas" autoplay playsinline></video>
            </div>
            <div class="controls">
                <button class="btn btn-danger" id="leaveBtn">Leave Session</button>
            </div>
            <div id="sessionStatus" class="status info" style="display: none;"></div>
        </div>
    </div>

    <script>
        let client;
        let stream;
        let isJoined = false;
        let sdkLoaded = false;

        // Check if SDK is loaded - try multiple possible global names
        function checkSDKLoaded() {
            // Check for WebVideoSDK (actual name from UMD build)
            if (typeof WebVideoSDK !== 'undefined') {
                // Alias it to ZoomVideo for compatibility
                if (typeof ZoomVideo === 'undefined') {
                    window.ZoomVideo = WebVideoSDK;
                }
                sdkLoaded = true;
                return true;
            }
            // Check for ZoomVideo (standard name)
            if (typeof ZoomVideo !== 'undefined') {
                sdkLoaded = true;
                return true;
            }
            // Check for window.ZoomVideo
            if (typeof window.ZoomVideo !== 'undefined') {
                sdkLoaded = true;
                return true;
            }
            // Check other possible names
            const possibleNames = ['WebVideoSDK', 'ZoomVideo', 'ZoomVideoSDK', 'zmVideo', 'Zoom'];
            for (const name of possibleNames) {
                if (typeof window[name] !== 'undefined') {
                    console.log(`Found Zoom SDK as: ${name}`);
                    window.ZoomVideo = window[name]; // Alias it
                    sdkLoaded = true;
                    return true;
                }
            }
            return false;
        }

        // Wait for SDK to load
        function waitForSDK(maxAttempts = 50, attempt = 0) {
            return new Promise((resolve, reject) => {
                if (checkSDKLoaded()) {
                    resolve();
                } else if (attempt >= maxAttempts) {
                    reject(new Error('Zoom Video SDK failed to load. Please refresh the page and check your internet connection.'));
                } else {
                    setTimeout(() => {
                        waitForSDK(maxAttempts, attempt + 1).then(resolve).catch(reject);
                    }, 100);
                }
            });
        }

        // Initialize Zoom Video SDK client
        function initZoomClient() {
            if (!checkSDKLoaded()) {
                showStatus('error', 'Zoom Video SDK is not loaded. Please wait a moment and try again.');
                return null;
            }

            try {
                // According to Zoom Video SDK docs: ZoomVideo.createClient()
                // WebVideoSDK.default is the equivalent of ZoomVideo in UMD build
                let VideoClient = null;
                
                // Method 1: WebVideoSDK.default has createClient directly (correct way)
                if (WebVideoSDK?.default && typeof WebVideoSDK.default.createClient === 'function') {
                    VideoClient = WebVideoSDK.default;
                }
                // Method 2: ZoomVideo (aliased) has createClient
                else if (ZoomVideo && typeof ZoomVideo.createClient === 'function') {
                    VideoClient = ZoomVideo;
                }
                // Method 3: Try WebVideoSDK.default.videoClient (fallback)
                else if (WebVideoSDK?.default?.videoClient && typeof WebVideoSDK.default.videoClient.createClient === 'function') {
                    VideoClient = WebVideoSDK.default.videoClient;
                }
                // Method 4: Try ZoomVideo.default
                else if (ZoomVideo?.default && typeof ZoomVideo.default.createClient === 'function') {
                    VideoClient = ZoomVideo.default;
                }
                
                if (!VideoClient || typeof VideoClient.createClient !== 'function') {
                    console.error('Available SDK structure:', {
                        WebVideoSDK: typeof WebVideoSDK,
                        default: typeof WebVideoSDK?.default,
                        defaultHasCreateClient: typeof WebVideoSDK?.default?.createClient,
                        defaultKeys: WebVideoSDK?.default ? Object.keys(WebVideoSDK.default).slice(0, 10) : []
                    });
                    throw new Error('VideoClient.createClient not found in SDK. WebVideoSDK.default.createClient should be available.');
                }
                
                // Create client using the correct method
                const zmClient = VideoClient.createClient();
                zmClient.init('en-US', 'Global', { patchJsMedia: true });
                return zmClient;
            } catch (error) {
                console.error('Error creating Zoom client:', error);
                showStatus('error', `Failed to create Zoom client: ${error.message}`);
                return null;
            }
        }

        // Check SDK on page load
        window.addEventListener('load', () => {
            waitForSDK().then(() => {
                console.log('Zoom Video SDK loaded successfully');
                // Hide any loading errors if SDK loads
                const statusDiv = document.getElementById('status');
                if (statusDiv.textContent.includes('failed to load')) {
                    statusDiv.style.display = 'none';
                }
            }).catch((error) => {
                console.error('SDK loading error:', error);
                showStatus('error', error.message);
            });
        });

        // Show status message
        function showStatus(type, message) {
            const statusDiv = document.getElementById('status');
            statusDiv.className = `status ${type}`;
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';
        }

        // Hide status message
        function hideStatus() {
            document.getElementById('status').style.display = 'none';
        }

        // Show session status
        function showSessionStatus(message) {
            const statusDiv = document.getElementById('sessionStatus');
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';
        }

        // Generate token from server
        async function generateToken(sessionName, role, sessionKey, userIdentity) {
            try {
                const response = await fetch('/api/generate-token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        sessionName,
                        role: parseInt(role),
                        sessionKey,
                        userIdentity
                    })
                });

                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to generate token');
                }

                return data.token;
            } catch (error) {
                throw new Error(`Token generation failed: ${error.message}`);
            }
        }

        // Join session
        async function joinSession(sessionName, token, userName, role) {
            try {
                showSessionStatus('Connecting to session...');
                
                await client.join(sessionName, token, userName);
                
                isJoined = true;
                const roleName = role === '1' ? 'Host' : 'Participant';
                showSessionStatus(`‚úÖ Successfully joined session as ${roleName}`);
                
                // Get media stream
                stream = client.getMediaStream();
                
                // Get video element reference
                const videoElement = document.getElementById('video-canvas');
                const currentUser = client.getCurrentUserInfo();
                
                // Function to safely render own video using attachVideo only
                const renderOwnVideo = () => {
                    if (!currentUser) {
                        console.log('No current user info available');
                        return;
                    }
                    
                    try {
                        // Use attachVideo method (required for video elements)
                        stream.attachVideo(videoElement, currentUser.userId);
                        console.log('Rendered own video using attachVideo');
                    } catch (renderError) {
                        // Handle specific error codes
                        if (renderError.errorCode === 6001) {
                            // "user is not send video" - video not ready yet, will retry
                            console.log('Video not ready yet, will retry when active');
                        } else if (renderError.errorCode === 6112) {
                            // "Use the attachVideo method" - we're already using it, might be timing issue
                            console.log('attachVideo timing issue, will retry');
                        } else {
                            console.warn('Error attaching video:', renderError);
                        }
                    }
                };
                
                // Request camera and microphone permissions
                try {
                    // Start video
                    await stream.startVideo();
                    console.log('Video started successfully');
                    
                    // Wait for video to be active before rendering
                    // Listen for video active change event - wait for "Active" state
                    let videoRendered = false;
                    const videoActiveHandler = (payload) => {
                        console.log('Video active change event:', payload);
                        
                        // Check if it's the current user and video is becoming active
                        if (payload.userId === currentUser.userId) {
                            if (payload.state === 'Active' || payload.action === 'Start') {
                                if (!videoRendered) {
                                    setTimeout(() => {
                                        renderOwnVideo();
                                        videoRendered = true;
                                    }, 500);
                                }
                            }
                        }
                    };
                    client.on('video-active-change', videoActiveHandler);
                    
                    // Also try after delays (fallback if event doesn't fire)
                    setTimeout(() => {
                        if (!videoRendered) {
                            console.log('Fallback: Attempting to render video after delay');
                            renderOwnVideo();
                        }
                    }, 1500);
                    
                    setTimeout(() => {
                        if (!videoRendered) {
                            console.log('Second fallback: Attempting to render video');
                            renderOwnVideo();
                        }
                    }, 3000);
                    
                } catch (videoError) {
                    console.warn('Video start failed:', videoError);
                    showSessionStatus('‚ö†Ô∏è Video could not be started. Check camera permissions.');
                }
                
                try {
                    // Start audio
                    await stream.startAudio();
                    console.log('Audio started successfully');
                } catch (audioError) {
                    console.warn('Audio start failed:', audioError);
                    showSessionStatus('‚ö†Ô∏è Audio could not be started. Check microphone permissions.');
                }
                
                // Listen for other participants joining
                client.on('user-added', (payload) => {
                    console.log('User added:', payload);
                    const user = Array.isArray(payload) ? payload[0] : payload;
                    const userName = user.displayName || user.userId || 'Unknown';
                    showSessionStatus(`üë§ ${userName} joined the session`);
                    
                    // Render video when peer starts video
                    setTimeout(() => {
                        try {
                            // Use attachVideo for peer video as well
                            stream.attachVideo(videoElement, user.userId);
                        } catch (err) {
                            console.warn('Could not render peer video:', err);
                            // Fallback to renderVideo
                            try {
                                stream.renderVideo(videoElement, user.userId, 1920, 1080, 0, 0, 3);
                            } catch (fallbackErr) {
                                console.warn('renderVideo also failed:', fallbackErr);
                            }
                        }
                    }, 500);
                });

                client.on('user-removed', (payload) => {
                    console.log('User removed:', payload);
                    const user = Array.isArray(payload) ? payload[0] : payload;
                    const userName = user.displayName || user.userId || 'Unknown';
                    showSessionStatus(`üë§ ${userName} left the session`);
                });

                // Listen for peer video state changes
                client.on('peer-video-state-change', (payload) => {
                    console.log('Peer video state changed:', payload);
                    if (payload.action === 'Start') {
                        // Wait a bit for video stream to be ready
                        setTimeout(() => {
                            try {
                                // Use attachVideo for peer video (required method)
                                stream.attachVideo(videoElement, payload.userId);
                                console.log(`Attached video for user: ${payload.userId}`);
                            } catch (err) {
                                // Handle specific error codes
                                if (err.errorCode === 6001) {
                                    console.log(`Video not ready yet for user ${payload.userId}, will retry`);
                                } else if (err.errorCode === 6112) {
                                    console.log(`Use attachVideo method for user ${payload.userId} - already using it`);
                                } else {
                                    console.warn('Error attaching peer video:', err);
                                }
                            }
                        }, 500);
                    }
                });

                // Listen for video active change events (more reliable)
                // Note: This handler is already set up above for own video, but we can use it for peers too
                // The video-active-change event fires for all users
                const peerVideoActiveHandler = (payload) => {
                    // Skip if it's the current user (handled separately)
                    if (payload.userId === currentUser.userId) {
                        return;
                    }
                    
                    console.log('Peer video active changed:', payload);
                    if (payload.state === 'Active' || payload.action === 'Start') {
                        setTimeout(() => {
                            try {
                                stream.attachVideo(videoElement, payload.userId);
                                console.log(`Attached peer video on active change for user: ${payload.userId}`);
                            } catch (err) {
                                // Handle specific error codes
                                if (err.errorCode === 6001 || err.errorCode === 6112) {
                                    console.log(`Video not ready for peer ${payload.userId}`);
                                } else {
                                    console.warn('Could not attach peer video on active change:', err);
                                }
                            }
                        }, 500);
                    }
                };
                client.on('video-active-change', peerVideoActiveHandler);

                // Listen for session errors
                client.on('error', (error) => {
                    console.error('Session error:', error);
                    showSessionStatus(`‚ùå Session error: ${error.reason || error.message || 'Unknown error'}`);
                });

                // Listen for connection quality changes
                client.on('connection-change', (payload) => {
                    console.log('Connection changed:', payload);
                    if (payload.state === 'Reconnecting') {
                        showSessionStatus('üîÑ Reconnecting to session...');
                    } else if (payload.state === 'Connected') {
                        showSessionStatus('‚úÖ Connected to session');
                    }
                });

            } catch (error) {
                console.error('Join session error:', error);
                
                // Provide helpful error messages for common authentication errors
                if (error.type === 'JOIN_MEETING_FAILED') {
                    if (error.reason && error.reason.includes('account does not exist')) {
                        throw new Error('Authentication failed: Invalid SDK credentials. Please check your .env file has valid ZOOM_VIDEO_SDK_KEY and ZOOM_VIDEO_SDK_SECRET. Get credentials at: https://developers.zoom.us/docs/video-sdk/get-credentials/');
                    }
                    throw new Error(`Failed to join session: ${error.reason || error.message}`);
                }
                
                throw error;
            }
        }

        // Leave session
        async function leaveSession() {
            try {
                if (stream) {
                    await stream.stopVideo();
                    await stream.stopAudio();
                }
                if (client && isJoined) {
                    await client.leave();
                }
                isJoined = false;
                
                document.getElementById('videoContainer').classList.remove('active');
                document.getElementById('formContainer').style.display = 'block';
                document.getElementById('joinBtn').disabled = false;
                showStatus('info', 'Left the session successfully');
            } catch (error) {
                console.error('Leave session error:', error);
                showStatus('error', `Error leaving session: ${error.message}`);
            }
        }


        // Tab switching functionality
        function switchTab(tab) {
            const createForm = document.getElementById('createSessionForm');
            const joinForm = document.getElementById('joinSessionForm');
            const createTab = document.getElementById('createTab');
            const joinTab = document.getElementById('joinTab');

            if (tab === 'create') {
                createForm.style.display = 'block';
                joinForm.style.display = 'none';
                createTab.classList.add('active');
                joinTab.classList.remove('active');
            } else {
                createForm.style.display = 'none';
                joinForm.style.display = 'block';
                createTab.classList.remove('active');
                joinTab.classList.add('active');
            }
            hideStatus();
        }

        // Validation functions for create form
        function validateCreateSessionName(value) {
            const help = document.getElementById('createSessionNameHelp');
            const input = document.getElementById('createSessionName');
            
            if (!value || value.trim().length === 0) {
                help.className = 'help-text';
                help.textContent = 'Choose a unique name for your session (letters, numbers, hyphens, underscores only)';
                input.style.borderColor = '';
                return false;
            }
            
            if (!/^[a-zA-Z0-9_-]+$/.test(value.trim())) {
                help.className = 'error-text';
                help.textContent = '‚ùå Session name can only contain letters, numbers, hyphens, and underscores';
                input.style.borderColor = '#f56565';
                return false;
            }
            
            if (value.length > 200) {
                help.className = 'error-text';
                help.textContent = '‚ùå Session name must be 200 characters or less';
                input.style.borderColor = '#f56565';
                return false;
            }
            
            help.className = 'success-text';
            help.textContent = '‚úÖ Session name format is valid';
            input.style.borderColor = '#48bb78';
            return true;
        }

        function validateCreateUserIdentity(value) {
            const help = document.getElementById('createUserIdentityHelp');
            const input = document.getElementById('createUserIdentity');
            
            if (!value || value.trim().length === 0) {
                help.className = 'help-text';
                help.textContent = 'Your display name as the session host';
                input.style.borderColor = '';
                return false;
            }
            
            if (value.length > 100) {
                help.className = 'error-text';
                help.textContent = '‚ùå Name must be 100 characters or less';
                input.style.borderColor = '#f56565';
                return false;
            }
            
            help.className = 'success-text';
            help.textContent = '‚úÖ Name is valid';
            input.style.borderColor = '#48bb78';
            return true;
        }

        function validateCreateSessionKey(value) {
            const help = document.getElementById('createSessionKeyHelp');
            const input = document.getElementById('createSessionKey');
            
            if (!value || value.trim().length === 0) {
                help.className = 'help-text';
                help.textContent = 'Create a secure key for this session. Share this with participants to join.';
                input.style.borderColor = '';
                return false;
            }
            
            if (value.length > 200) {
                help.className = 'error-text';
                help.textContent = '‚ùå Session key must be 200 characters or less';
                input.style.borderColor = '#f56565';
                return false;
            }
            
            help.className = 'success-text';
            help.textContent = '‚úÖ Session key is valid';
            input.style.borderColor = '#48bb78';
            return true;
        }

        // Validation functions for join form (reuse existing)
        function validateJoinSessionName(value) {
            const help = document.getElementById('joinSessionNameHelp');
            const input = document.getElementById('joinSessionName');
            
            if (!value || value.trim().length === 0) {
                help.className = 'help-text';
                help.textContent = 'Enter the exact session name provided by the host';
                input.style.borderColor = '';
                return false;
            }
            
            if (!/^[a-zA-Z0-9_-]+$/.test(value.trim())) {
                help.className = 'error-text';
                help.textContent = '‚ùå Session name can only contain letters, numbers, hyphens, and underscores';
                input.style.borderColor = '#f56565';
                return false;
            }
            
            if (value.length > 200) {
                help.className = 'error-text';
                help.textContent = '‚ùå Session name must be 200 characters or less';
                input.style.borderColor = '#f56565';
                return false;
            }
            
            help.className = 'success-text';
            help.textContent = '‚úÖ Session name format is valid';
            input.style.borderColor = '#48bb78';
            return true;
        }

        function validateJoinUserIdentity(value) {
            const help = document.getElementById('joinUserIdentityHelp');
            const input = document.getElementById('joinUserIdentity');
            
            if (!value || value.trim().length === 0) {
                help.className = 'help-text';
                help.textContent = 'Your display name in the session';
                input.style.borderColor = '';
                return false;
            }
            
            if (value.length > 100) {
                help.className = 'error-text';
                help.textContent = '‚ùå Name must be 100 characters or less';
                input.style.borderColor = '#f56565';
                return false;
            }
            
            help.className = 'success-text';
            help.textContent = '‚úÖ Name is valid';
            input.style.borderColor = '#48bb78';
            return true;
        }

        function validateJoinSessionKey(value) {
            const help = document.getElementById('joinSessionKeyHelp');
            const input = document.getElementById('joinSessionKey');
            
            if (!value || value.trim().length === 0) {
                help.className = 'help-text';
                help.textContent = 'Enter the session key provided by the host';
                input.style.borderColor = '';
                return false;
            }
            
            if (value.length > 200) {
                help.className = 'error-text';
                help.textContent = '‚ùå Session key must be 200 characters or less';
                input.style.borderColor = '#f56565';
                return false;
            }
            
            help.className = 'success-text';
            help.textContent = '‚úÖ Session key is valid';
            input.style.borderColor = '#48bb78';
            return true;
        }

        // Add real-time validation listeners for create form
        document.getElementById('createSessionName').addEventListener('input', (e) => {
            validateCreateSessionName(e.target.value);
        });

        document.getElementById('createUserIdentity').addEventListener('input', (e) => {
            validateCreateUserIdentity(e.target.value);
        });

        document.getElementById('createSessionKey').addEventListener('input', (e) => {
            validateCreateSessionKey(e.target.value);
        });

        // Add real-time validation listeners for join form
        document.getElementById('joinSessionName').addEventListener('input', (e) => {
            validateJoinSessionName(e.target.value);
        });

        document.getElementById('joinUserIdentity').addEventListener('input', (e) => {
            validateJoinUserIdentity(e.target.value);
        });

        document.getElementById('joinSessionKey').addEventListener('input', (e) => {
            validateJoinSessionKey(e.target.value);
        });

        // Create Session Form Handler
        document.getElementById('createSessionForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const sessionName = document.getElementById('createSessionName').value.trim();
            const userIdentity = document.getElementById('createUserIdentity').value.trim();
            const sessionKey = document.getElementById('createSessionKey').value.trim();
            const role = '1'; // Host role for creating sessions

            // Validate all fields
            const nameValid = validateCreateSessionName(sessionName);
            const identityValid = validateCreateUserIdentity(userIdentity);
            const keyValid = validateCreateSessionKey(sessionKey);

            if (!nameValid || !identityValid || !keyValid) {
                showStatus('error', 'Please fix the validation errors above before creating the session');
                return;
            }

            hideStatus();
            document.getElementById('createBtn').disabled = true;
            document.getElementById('createBtn').textContent = 'Creating Session...';

            try {
                // Wait for SDK to be loaded
                showStatus('info', 'Loading Zoom Video SDK...');
                await waitForSDK();

                // Initialize client
                client = initZoomClient();
                if (!client) {
                    throw new Error('Failed to initialize Zoom Video SDK client');
                }

                // Generate token
                showStatus('info', 'Generating authentication token...');
                const token = await generateToken(sessionName, role, sessionKey, userIdentity);

                // Join session as host
                showStatus('info', 'Creating and joining session as host...');
                await joinSession(sessionName, token, userIdentity, role);

                // Show success message with session details
                showStatus('success', `‚úÖ Session created successfully!\n\nüìã Session Details:\nSession Name: ${sessionName}\nSession Key: ${sessionKey}\n\nShare these details with participants to join.`);

                // Show video container
                document.getElementById('videoContainer').classList.add('active');
                document.getElementById('formContainer').style.display = 'none';

            } catch (error) {
                console.error('Error:', error);
                
                let errorMessage = error.message || 'An unknown error occurred';
                
                if (errorMessage.includes('Authentication failed') || errorMessage.includes('account does not exist')) {
                    errorMessage += '\n\nüí° Tip: Visit http://localhost:3000/setup-credentials.html to validate your credentials';
                }
                
                showStatus('error', errorMessage);
                document.getElementById('createBtn').disabled = false;
                document.getElementById('createBtn').textContent = '‚ûï Create & Join Session';
            }
        });

        // Join Session Form Handler
        document.getElementById('joinSessionForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const sessionName = document.getElementById('joinSessionName').value.trim();
            const userIdentity = document.getElementById('joinUserIdentity').value.trim();
            const sessionKey = document.getElementById('joinSessionKey').value.trim();
            const role = '0'; // Participant role for joining sessions

            // Validate all fields
            const nameValid = validateJoinSessionName(sessionName);
            const identityValid = validateJoinUserIdentity(userIdentity);
            const keyValid = validateJoinSessionKey(sessionKey);

            if (!nameValid || !identityValid || !keyValid) {
                showStatus('error', 'Please fix the validation errors above before joining');
                return;
            }

            // Optional: Validate with server
            try {
                const validationResponse = await fetch('/api/validate-session-inputs', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        sessionName,
                        userIdentity,
                        sessionKey,
                        role
                    })
                });

                const validationData = await validationResponse.json();
                if (!validationData.valid) {
                    showStatus('error', validationData.errors.join(', '));
                    return;
                }
            } catch (error) {
                console.warn('Server validation failed, proceeding with client-side validation:', error);
            }

            hideStatus();
            document.getElementById('joinBtn').disabled = true;
            document.getElementById('joinBtn').textContent = 'Connecting...';

            try {
                // Wait for SDK to be loaded
                showStatus('info', 'Loading Zoom Video SDK...');
                await waitForSDK();

                // Initialize client
                client = initZoomClient();
                if (!client) {
                    throw new Error('Failed to initialize Zoom Video SDK client');
                }

                // Generate token
                showStatus('info', 'Generating authentication token...');
                const token = await generateToken(sessionName, role, sessionKey, userIdentity);

                // Join session
                showStatus('info', 'Joining session...');
                await joinSession(sessionName, token, userIdentity, role);

                // Show video container
                document.getElementById('videoContainer').classList.add('active');
                document.getElementById('formContainer').style.display = 'none';
                hideStatus();

            } catch (error) {
                console.error('Error:', error);
                
                // Show user-friendly error message
                let errorMessage = error.message || 'An unknown error occurred';
                
                // Add troubleshooting link for authentication errors
                if (errorMessage.includes('Authentication failed') || errorMessage.includes('account does not exist')) {
                    errorMessage += '\n\nüí° Tip: Visit http://localhost:3000/setup-credentials.html to validate your credentials';
                }
                
                showStatus('error', errorMessage);
                document.getElementById('joinBtn').disabled = false;
                document.getElementById('joinBtn').textContent = 'üîó Join Session';
            }
        });

        // Leave button handler
        document.getElementById('leaveBtn').addEventListener('click', leaveSession);
    </script>
</body>
</html>

